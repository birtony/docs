<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1996px" preserveAspectRatio="none" style="width:773px;height:1996px;background:#FFFFFF;" version="1.1" viewBox="0 0 773 1996" width="773px" zoomAndPan="magnify"><defs/><g><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="128.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="245.2578"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="361.7891"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="520.4531"/><rect fill="#FFFFFF" height="109.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="719.3828"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="1016.8438"/><rect fill="#FFFFFF" height="94.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="1471.1719"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="1753.5"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="186.9922"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="303.5234"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="578.7188"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="858.1797"/><rect fill="#FFFFFF" height="109.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="1258.9766"/><rect fill="#FFFFFF" height="129.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="420.0547"/><rect fill="#FFFFFF" height="250.3281" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="636.9844"/><rect fill="#FFFFFF" height="168.7344" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="1045.9766"/><rect fill="#FFFFFF" height="49.9375" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="1782.6328"/><rect fill="#FFFFFF" height="129.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="526.5" y="916.4453"/><rect fill="#FFFFFF" height="211.0625" style="stroke:#181818;stroke-width:1.0;" width="10" x="526.5" y="1412.9063"/><rect fill="#FFFFFF" height="129.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="526.5" y="1653.1016"/><rect fill="#FFFFFF" height="109.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="638.5" y="1105.0469"/><rect height="1201.5859" style="stroke:#000000;stroke-width:1.5;fill:none;" width="660.5" x="105.5" y="681.1172"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="41" x2="41" y1="97.5938" y2="1899.7031"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="147.5" x2="147.5" y1="97.5938" y2="1899.7031"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="251.5" x2="251.5" y1="97.5938" y2="1899.7031"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="419.5" x2="419.5" y1="97.5938" y2="1899.7031"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="531" x2="531" y1="97.5938" y2="1899.7031"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="643.5" x2="643.5" y1="97.5938" y2="1899.7031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="5" y="77.9951">Publisher</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="16.5" y="94.292">Client</text><ellipse cx="41" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M41,21.5 L41,48.5 M28,29.5 L54,29.5 M41,48.5 L28,63.5 M41,48.5 L54,63.5 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66" x="5" y="1911.6982">Publisher</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="16.5" y="1927.9951">Client</text><ellipse cx="41" cy="1939.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M41,1947.7969 L41,1974.7969 M28,1955.7969 L54,1955.7969 M41,1974.7969 L28,1989.7969 M41,1974.7969 L54,1989.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><path d="M120.5,55 L175.5,55 C180.5,55 180.5,76.2969 180.5,76.2969 C180.5,76.2969 180.5,97.5938 175.5,97.5938 L120.5,97.5938 C115.5,97.5938 115.5,76.2969 115.5,76.2969 C115.5,76.2969 115.5,55 120.5,55 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M175.5,55 C170.5,55 170.5,76.2969 170.5,76.2969 C170.5,97.5938 175.5,97.5938 175.5,97.5938 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="128" y="72.9951">App</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="120.5" y="89.292">Queue</text><path d="M120.5,1898.7031 L175.5,1898.7031 C180.5,1898.7031 180.5,1920 180.5,1920 C180.5,1920 180.5,1941.2969 175.5,1941.2969 L120.5,1941.2969 C115.5,1941.2969 115.5,1920 115.5,1920 C115.5,1920 115.5,1898.7031 120.5,1898.7031 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M175.5,1898.7031 C170.5,1898.7031 170.5,1920 170.5,1920 C170.5,1941.2969 175.5,1941.2969 175.5,1941.2969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="128" y="1916.6982">App</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="120.5" y="1932.9951">Queue</text><path d="M195.5,71.2969 L307.5,71.2969 C312.5,71.2969 312.5,84.4453 312.5,84.4453 C312.5,84.4453 312.5,97.5938 307.5,97.5938 L195.5,97.5938 C190.5,97.5938 190.5,84.4453 190.5,84.4453 C190.5,84.4453 190.5,71.2969 195.5,71.2969 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M307.5,71.2969 C302.5,71.2969 302.5,84.4453 302.5,84.4453 C302.5,97.5938 307.5,97.5938 307.5,97.5938 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="195.5" y="89.292">orb.redelivery</text><path d="M195.5,1898.7031 L307.5,1898.7031 C312.5,1898.7031 312.5,1911.8516 312.5,1911.8516 C312.5,1911.8516 312.5,1925 307.5,1925 L195.5,1925 C190.5,1925 190.5,1911.8516 190.5,1911.8516 C190.5,1911.8516 190.5,1898.7031 195.5,1898.7031 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M307.5,1898.7031 C302.5,1898.7031 302.5,1911.8516 302.5,1911.8516 C302.5,1925 307.5,1925 307.5,1925 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="195.5" y="1916.6982">orb.redelivery</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="375.5" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="406" y="69.9951">Orb</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="382.5" y="86.292">Instance 1</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88" x="375.5" y="1898.7031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="406" y="1918.6982">Orb</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="382.5" y="1934.9951">Instance 1</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="87" x="488" y="50"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="518" y="69.9951">Orb</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="495" y="86.292">Instance 2</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="87" x="488" y="1898.7031"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="518" y="1918.6982">Orb</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="495" y="1934.9951">Instance 2</text><path d="M608.5,71.2969 L678.5,71.2969 C683.5,71.2969 683.5,84.4453 683.5,84.4453 C683.5,84.4453 683.5,97.5938 678.5,97.5938 L608.5,97.5938 C603.5,97.5938 603.5,84.4453 603.5,84.4453 C603.5,84.4453 603.5,71.2969 608.5,71.2969 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M678.5,71.2969 C673.5,71.2969 673.5,84.4453 673.5,84.4453 C673.5,97.5938 678.5,97.5938 678.5,97.5938 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="608.5" y="89.292">orb.wait</text><path d="M608.5,1898.7031 L678.5,1898.7031 C683.5,1898.7031 683.5,1911.8516 683.5,1911.8516 C683.5,1911.8516 683.5,1925 678.5,1925 L608.5,1925 C603.5,1925 603.5,1911.8516 603.5,1911.8516 C603.5,1911.8516 603.5,1898.7031 608.5,1898.7031 " fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M678.5,1898.7031 C673.5,1898.7031 673.5,1911.8516 673.5,1911.8516 C673.5,1925 678.5,1925 678.5,1925 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="608.5" y="1916.6982">orb.wait</text><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="128.7266"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="245.2578"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="361.7891"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="520.4531"/><rect fill="#FFFFFF" height="109.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="719.3828"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="1016.8438"/><rect fill="#FFFFFF" height="94.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="1471.1719"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="143" y="1753.5"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="186.9922"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="303.5234"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="578.7188"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="858.1797"/><rect fill="#FFFFFF" height="109.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="246.5" y="1258.9766"/><rect fill="#FFFFFF" height="129.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="420.0547"/><rect fill="#FFFFFF" height="250.3281" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="636.9844"/><rect fill="#FFFFFF" height="168.7344" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="1045.9766"/><rect fill="#FFFFFF" height="49.9375" style="stroke:#181818;stroke-width:1.0;" width="10" x="414.5" y="1782.6328"/><rect fill="#FFFFFF" height="129.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="526.5" y="916.4453"/><rect fill="#FFFFFF" height="211.0625" style="stroke:#181818;stroke-width:1.0;" width="10" x="526.5" y="1412.9063"/><rect fill="#FFFFFF" height="129.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="526.5" y="1653.1016"/><rect fill="#FFFFFF" height="109.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="638.5" y="1105.0469"/><polygon fill="#181818" points="164,124.7266,154,128.7266,164,132.7266,160,128.7266" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="418.5" y1="128.7266" y2="128.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="170" y="123.6606">subscribe</text><polygon fill="#181818" points="407.5,153.8594,417.5,157.8594,407.5,161.8594,411.5,157.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="413.5" y1="157.8594" y2="157.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="152.7935">ok</text><polygon fill="#181818" points="267.5,182.9922,257.5,186.9922,267.5,190.9922,263.5,186.9922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="261.5" x2="418.5" y1="186.9922" y2="186.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="273.5" y="181.9263">subscribe</text><polygon fill="#181818" points="407.5,212.125,417.5,216.125,407.5,220.125,411.5,216.125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="251.5" x2="413.5" y1="216.125" y2="216.125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="258.5" y="211.0591">ok</text><polygon fill="#181818" points="164,241.2578,154,245.2578,164,249.2578,160,245.2578" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="530.5" y1="245.2578" y2="245.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="170" y="240.1919">subscribe</text><polygon fill="#181818" points="519.5,270.3906,529.5,274.3906,519.5,278.3906,523.5,274.3906" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="525.5" y1="274.3906" y2="274.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="269.3247">ok</text><polygon fill="#181818" points="267.5,299.5234,257.5,303.5234,267.5,307.5234,263.5,303.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="261.5" x2="530.5" y1="303.5234" y2="303.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="273.5" y="298.4575">subscribe</text><polygon fill="#181818" points="519.5,328.6563,529.5,332.6563,519.5,336.6563,523.5,332.6563" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="251.5" x2="525.5" y1="332.6563" y2="332.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="258.5" y="327.5903">ok</text><polygon fill="#181818" points="131,357.7891,141,361.7891,131,365.7891,135,361.7891" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="41" x2="137" y1="361.7891" y2="361.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="48" y="356.7231">publish(msg)</text><polygon fill="#181818" points="52,386.9219,42,390.9219,52,394.9219,48,390.9219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="46" x2="147" y1="390.9219" y2="390.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="58" y="385.856">ok</text><polygon fill="#181818" points="402.5,416.0547,412.5,420.0547,402.5,424.0547,406.5,420.0547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="148" x2="408.5" y1="420.0547" y2="420.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="155" y="414.9888">msg</text><polygon fill="#181818" points="159,445.1875,149,449.1875,159,453.1875,155,449.1875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="153" x2="413.5" y1="449.1875" y2="449.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="165" y="444.1216">ok</text><line style="stroke:#181818;stroke-width:1.0;" x1="424.5" x2="466.5" y1="478.3203" y2="478.3203"/><line style="stroke:#181818;stroke-width:1.0;" x1="466.5" x2="466.5" y1="478.3203" y2="491.3203"/><line style="stroke:#181818;stroke-width:1.0;" x1="425.5" x2="466.5" y1="491.3203" y2="491.3203"/><polygon fill="#181818" points="435.5,487.3203,425.5,491.3203,435.5,495.3203,431.5,491.3203" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="431.5" y="473.2544">process(msg)</text><polygon fill="#181818" points="164,516.4531,154,520.4531,164,524.4531,160,520.4531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="413.5" y1="520.4531" y2="520.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="170" y="515.3872">Nack</text><polygon fill="#181818" points="407.5,545.5859,417.5,549.5859,407.5,553.5859,411.5,549.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="413.5" y1="549.5859" y2="549.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="544.52">ok</text><polygon fill="#181818" points="234.5,574.7188,244.5,578.7188,234.5,582.7188,238.5,578.7188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="148" x2="240.5" y1="578.7188" y2="578.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="155" y="573.6528">msg</text><polygon fill="#181818" points="159,603.8516,149,607.8516,159,611.8516,155,607.8516" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="153" x2="250.5" y1="607.8516" y2="607.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="165" y="602.7856">ok</text><polygon fill="#181818" points="402.5,632.9844,412.5,636.9844,402.5,640.9844,406.5,636.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="251.5" x2="408.5" y1="636.9844" y2="636.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="258.5" y="631.9185">msg(reason=rejected)</text><polygon fill="#181818" points="262.5,662.1172,252.5,666.1172,262.5,670.1172,258.5,666.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="256.5" x2="413.5" y1="666.1172" y2="666.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="268.5" y="661.0513">ok</text><path d="M105.5,681.1172 L171.5,681.1172 L171.5,688.25 L161.5,698.25 L105.5,698.25 L105.5,681.1172 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1201.5859" style="stroke:#000000;stroke-width:1.5;" width="660.5" x="105.5" y="681.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="21" x="120.5" y="694.1841">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="156" x="186.5" y="693.3276">[Redelivery count == 0]</text><polygon fill="#181818" points="164,715.3828,154,719.3828,164,723.3828,160,719.3828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="413.5" y1="719.3828" y2="719.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="170" y="714.3169">msg(redeliveryCount=1)</text><path d="M330,732.3828 L330,802.3828 L509,802.3828 L509,742.3828 L499,732.3828 L330,732.3828 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M499,732.3828 L499,742.3828 L509,742.3828 L499,732.3828 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="336" y="749.4497">Increment the redelivery</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="336" y="764.5825">count in the message's</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="336" y="779.7153">metadata and re-post</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="336" y="794.8481">immediately</text><polygon fill="#181818" points="402.5,825.0469,412.5,829.0469,402.5,833.0469,406.5,829.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="408.5" y1="829.0469" y2="829.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="823.981">ok</text><polygon fill="#181818" points="267.5,854.1797,257.5,858.1797,267.5,862.1797,263.5,858.1797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="261.5" x2="413.5" y1="858.1797" y2="858.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="273.5" y="853.1138">Ack</text><polygon fill="#181818" points="407.5,883.3125,417.5,887.3125,407.5,891.3125,411.5,887.3125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="251.5" x2="413.5" y1="887.3125" y2="887.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="258.5" y="882.2466">ok</text><polygon fill="#181818" points="514.5,912.4453,524.5,916.4453,514.5,920.4453,518.5,916.4453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="148" x2="520.5" y1="916.4453" y2="916.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="155" y="911.3794">msg(redeliveryCount=1)</text><polygon fill="#181818" points="159,941.5781,149,945.5781,159,949.5781,155,945.5781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="153" x2="525.5" y1="945.5781" y2="945.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="165" y="940.5122">ok</text><line style="stroke:#181818;stroke-width:1.0;" x1="536.5" x2="578.5" y1="974.7109" y2="974.7109"/><line style="stroke:#181818;stroke-width:1.0;" x1="578.5" x2="578.5" y1="974.7109" y2="987.7109"/><line style="stroke:#181818;stroke-width:1.0;" x1="537.5" x2="578.5" y1="987.7109" y2="987.7109"/><polygon fill="#181818" points="547.5,983.7109,537.5,987.7109,547.5,991.7109,543.5,987.7109" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="543.5" y="969.645">process(msg)</text><polygon fill="#181818" points="164,1012.8438,154,1016.8438,164,1020.8438,160,1016.8438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="525.5" y1="1016.8438" y2="1016.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="170" y="1011.7778">Ack</text><polygon fill="#181818" points="519.5,1041.9766,529.5,1045.9766,519.5,1049.9766,523.5,1045.9766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="525.5" y1="1045.9766" y2="1045.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="1040.9106">ok</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="105.5" x2="766" y1="1054.9766" y2="1054.9766"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="147" x="110.5" y="1065.187">[Redelivery count &gt; 0]</text><polygon fill="#181818" points="626.5,1101.0469,636.5,1105.0469,626.5,1109.0469,630.5,1105.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="424.5" x2="632.5" y1="1105.0469" y2="1105.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="431.5" y="1084.8481">msg(redeliverCount=1;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="431.5" y="1099.981">expiration=2s)</text><path d="M318,1118.0469 L318,1188.0469 L521,1188.0469 L521,1128.0469 L511,1118.0469 L318,1118.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M511,1118.0469 L511,1128.0469 L521,1128.0469 L511,1118.0469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="324" y="1135.1138">Send the message to the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="324" y="1150.2466">wait queue with 'expiration'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="324" y="1165.3794">header so that the message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="324" y="1180.5122">expires</text><polygon fill="#181818" points="430.5,1210.7109,420.5,1214.7109,430.5,1218.7109,426.5,1214.7109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="424.5" x2="642.5" y1="1214.7109" y2="1214.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="436.5" y="1209.645">ok</text><polygon fill="#181818" points="267.5,1254.9766,257.5,1258.9766,267.5,1262.9766,263.5,1258.9766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="261.5" x2="642.5" y1="1258.9766" y2="1258.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="273.5" y="1238.7778">msg(reason=expired;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="273.5" y="1253.9106">redeliveryCount=1)</text><path d="M531,1271.9766 L531,1341.9766 L756,1341.9766 L756,1281.9766 L746,1271.9766 L531,1271.9766 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M746,1271.9766 L746,1281.9766 L756,1281.9766 L746,1271.9766 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="537" y="1289.0435">The message expires (after the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="537" y="1304.1763">time specified in the 'expiration'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="537" y="1319.3091">header) and is automatically</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="537" y="1334.4419">sent to the redelivery queue</text><polygon fill="#181818" points="631.5,1364.6406,641.5,1368.6406,631.5,1372.6406,635.5,1368.6406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="251.5" x2="637.5" y1="1368.6406" y2="1368.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="258.5" y="1363.5747">ok</text><polygon fill="#181818" points="514.5,1408.9063,524.5,1412.9063,514.5,1416.9063,518.5,1412.9063" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="251.5" x2="520.5" y1="1412.9063" y2="1412.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="258.5" y="1392.7075">msg(reason=expired;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="258.5" y="1407.8403">redeliverCount=1)</text><polygon fill="#181818" points="262.5,1438.0391,252.5,1442.0391,262.5,1446.0391,258.5,1442.0391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="256.5" x2="525.5" y1="1442.0391" y2="1442.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="268.5" y="1436.9731">ok</text><polygon fill="#181818" points="164,1467.1719,154,1471.1719,164,1475.1719,160,1471.1719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="525.5" y1="1471.1719" y2="1471.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="170" y="1466.106">msg(redeliveryCount=2)</text><path d="M442,1484.1719 L442,1539.1719 L621,1539.1719 L621,1494.1719 L611,1484.1719 L442,1484.1719 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M611,1484.1719 L611,1494.1719 L621,1494.1719 L611,1484.1719 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="448" y="1501.2388">Increment the redelivery</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="448" y="1516.3716">count and re-post</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84" x="448" y="1531.5044">the message</text><polygon fill="#181818" points="514.5,1561.7031,524.5,1565.7031,514.5,1569.7031,518.5,1565.7031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="520.5" y1="1565.7031" y2="1565.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="1560.6372">ok</text><polygon fill="#181818" points="262.5,1590.8359,252.5,1594.8359,262.5,1598.8359,258.5,1594.8359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="256.5" x2="525.5" y1="1594.8359" y2="1594.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="268.5" y="1589.77">Ack</text><polygon fill="#181818" points="519.5,1619.9688,529.5,1623.9688,519.5,1627.9688,523.5,1623.9688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="251.5" x2="525.5" y1="1623.9688" y2="1623.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="258.5" y="1618.9028">ok</text><polygon fill="#181818" points="514.5,1649.1016,524.5,1653.1016,514.5,1657.1016,518.5,1653.1016" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="148" x2="520.5" y1="1653.1016" y2="1653.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="155" y="1648.0356">msg(redeliveryCount=2)</text><polygon fill="#181818" points="159,1678.2344,149,1682.2344,159,1686.2344,155,1682.2344" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="153" x2="525.5" y1="1682.2344" y2="1682.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="165" y="1677.1685">ok</text><line style="stroke:#181818;stroke-width:1.0;" x1="536.5" x2="578.5" y1="1711.3672" y2="1711.3672"/><line style="stroke:#181818;stroke-width:1.0;" x1="578.5" x2="578.5" y1="1711.3672" y2="1724.3672"/><line style="stroke:#181818;stroke-width:1.0;" x1="537.5" x2="578.5" y1="1724.3672" y2="1724.3672"/><polygon fill="#181818" points="547.5,1720.3672,537.5,1724.3672,547.5,1728.3672,543.5,1724.3672" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="543.5" y="1706.3013">process(msg)</text><polygon fill="#181818" points="164,1749.5,154,1753.5,164,1757.5,160,1753.5" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="158" x2="525.5" y1="1753.5" y2="1753.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="170" y="1748.4341">Ack</text><polygon fill="#181818" points="519.5,1778.6328,529.5,1782.6328,519.5,1786.6328,523.5,1782.6328" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="148" x2="525.5" y1="1782.6328" y2="1782.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="15" x="155" y="1777.5669">ok</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="105.5" x2="766" y1="1791.6328" y2="1791.6328"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="303" x="110.5" y="1801.8433">[Redelivery count &gt; max redelivery attempts]</text><line style="stroke:#181818;stroke-width:1.0;" x1="424.5" x2="466.5" y1="1831.5703" y2="1831.5703"/><line style="stroke:#181818;stroke-width:1.0;" x1="466.5" x2="466.5" y1="1831.5703" y2="1844.5703"/><line style="stroke:#181818;stroke-width:1.0;" x1="419.5" x2="466.5" y1="1844.5703" y2="1844.5703"/><polygon fill="#181818" points="429.5,1840.5703,419.5,1844.5703,429.5,1848.5703,425.5,1844.5703" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="431.5" y="1826.5044">Log warning</text><path d="M336,1852.5703 L336,1877.5703 L502,1877.5703 L502,1862.5703 L492,1852.5703 L336,1852.5703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M492,1852.5703 L492,1862.5703 L502,1862.5703 L492,1852.5703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="342" y="1869.6372">Abandon the message</text><!--MD5=[99c8b598e740c44dde19751cc6efb4d0]
@startuml
'https://plantuml.com/sequence-diagram

actor "Publisher\nClient" as client

queue "App\nQueue" as queue1
queue "orb.redelivery" as redeliveryQueue

participant "Orb\nInstance 1" as service1
participant "Orb\nInstance 2" as service2

queue "orb.wait" as waitQueue

service1 -> queue1: subscribe
activate queue1
  queue1 - -> service1: ok
deactivate queue1

service1 -> redeliveryQueue: subscribe
activate redeliveryQueue
  redeliveryQueue - -> service1: ok
deactivate redeliveryQueue

service2 -> queue1: subscribe
activate queue1
  queue1 - -> service2: ok
deactivate queue1

service2 -> redeliveryQueue: subscribe
activate redeliveryQueue
  redeliveryQueue - -> service2: ok
deactivate redeliveryQueue

client -> queue1: publish(msg)
activate queue1
  queue1 - -> client: ok
deactivate queue1

queue1 -> service1: msg

activate service1
service1 - -> queue1: ok
service1 -> service1: process(msg)

service1 -> queue1: Nack
activate queue1
queue1 - -> service1: ok
deactivate queue1
deactivate service1

queue1 -> redeliveryQueue: msg
activate redeliveryQueue
redeliveryQueue - -> queue1: ok
deactivate redeliveryQueue

redeliveryQueue -> service1: msg(reason=rejected)
activate service1

service1 - -> redeliveryQueue: ok

alt Redelivery count == 0
  service1 -> queue1: msg(redeliveryCount=1)

  note over service1
  Increment the redelivery
  count in the message's
  metadata and re-post
  immediately
  end note

  activate queue1
  queue1 - -> service1: ok
  deactivate queue1

  service1 -> redeliveryQueue: Ack
  activate redeliveryQueue
  redeliveryQueue - -> service1: ok
  deactivate redeliveryQueue
  deactivate service1

  queue1 -> service2: msg(redeliveryCount=1)

  activate service2
  service2 - -> queue1: ok
  service2 -> service2: process(msg)

  service2 -> queue1: Ack
  activate queue1
  queue1 - -> service2: ok
  deactivate queue1
  deactivate service2
else Redelivery count > 0
  activate service1
  service1 -> waitQueue: msg(redeliverCount=1;\nexpiration=2s)

  note over service1
    Send the message to the
    wait queue with 'expiration'
    header so that the message
    expires
  end note

  activate waitQueue
  waitQueue - -> service1: ok
  deactivate waitQueue
  deactivate service1

  waitQueue -> redeliveryQueue: msg(reason=expired;\nredeliveryCount=1)

  note over waitQueue
  The message expires (after the
  time specified in the 'expiration'
  header) and is automatically
  sent to the redelivery queue
  end note

  activate redeliveryQueue
  redeliveryQueue - -> waitQueue: ok
  deactivate redeliveryQueue

  redeliveryQueue -> service2: msg(reason=expired;\nredeliverCount=1)
  activate service2
  service2 - -> redeliveryQueue: ok

  service2 -> queue1: msg(redeliveryCount=2)

  note over service2
  Increment the redelivery
  count and re-post
  the message
  end note

  activate queue1
  queue1 - -> service2: ok
  deactivate queue1
  service2 -> redeliveryQueue: Ack
  redeliveryQueue - -> service2: ok
  deactivate service2

  queue1 -> service2: msg(redeliveryCount=2)

  activate service2
  service2 - -> queue1: ok
  service2 -> service2: process(msg)

  service2 -> queue1: Ack
  activate queue1
  queue1 - -> service2: ok
  deactivate queue1
  deactivate service2
else Redelivery count > max redelivery attempts
  activate service1
  service1 -> service1: Log warning
  note over service1: Abandon the message
  deactivate service1
end

deactivate service1
@enduml

@startuml

actor "Publisher\nClient" as client

queue "App\nQueue" as queue1
queue "orb.redelivery" as redeliveryQueue

participant "Orb\nInstance 1" as service1
participant "Orb\nInstance 2" as service2

queue "orb.wait" as waitQueue

service1 -> queue1: subscribe
activate queue1
  queue1 - -> service1: ok
deactivate queue1

service1 -> redeliveryQueue: subscribe
activate redeliveryQueue
  redeliveryQueue - -> service1: ok
deactivate redeliveryQueue

service2 -> queue1: subscribe
activate queue1
  queue1 - -> service2: ok
deactivate queue1

service2 -> redeliveryQueue: subscribe
activate redeliveryQueue
  redeliveryQueue - -> service2: ok
deactivate redeliveryQueue

client -> queue1: publish(msg)
activate queue1
  queue1 - -> client: ok
deactivate queue1

queue1 -> service1: msg

activate service1
service1 - -> queue1: ok
service1 -> service1: process(msg)

service1 -> queue1: Nack
activate queue1
queue1 - -> service1: ok
deactivate queue1
deactivate service1

queue1 -> redeliveryQueue: msg
activate redeliveryQueue
redeliveryQueue - -> queue1: ok
deactivate redeliveryQueue

redeliveryQueue -> service1: msg(reason=rejected)
activate service1

service1 - -> redeliveryQueue: ok

alt Redelivery count == 0
  service1 -> queue1: msg(redeliveryCount=1)

  note over service1
  Increment the redelivery
  count in the message's
  metadata and re-post
  immediately
  end note

  activate queue1
  queue1 - -> service1: ok
  deactivate queue1

  service1 -> redeliveryQueue: Ack
  activate redeliveryQueue
  redeliveryQueue - -> service1: ok
  deactivate redeliveryQueue
  deactivate service1

  queue1 -> service2: msg(redeliveryCount=1)

  activate service2
  service2 - -> queue1: ok
  service2 -> service2: process(msg)

  service2 -> queue1: Ack
  activate queue1
  queue1 - -> service2: ok
  deactivate queue1
  deactivate service2
else Redelivery count > 0
  activate service1
  service1 -> waitQueue: msg(redeliverCount=1;\nexpiration=2s)

  note over service1
    Send the message to the
    wait queue with 'expiration'
    header so that the message
    expires
  end note

  activate waitQueue
  waitQueue - -> service1: ok
  deactivate waitQueue
  deactivate service1

  waitQueue -> redeliveryQueue: msg(reason=expired;\nredeliveryCount=1)

  note over waitQueue
  The message expires (after the
  time specified in the 'expiration'
  header) and is automatically
  sent to the redelivery queue
  end note

  activate redeliveryQueue
  redeliveryQueue - -> waitQueue: ok
  deactivate redeliveryQueue

  redeliveryQueue -> service2: msg(reason=expired;\nredeliverCount=1)
  activate service2
  service2 - -> redeliveryQueue: ok

  service2 -> queue1: msg(redeliveryCount=2)

  note over service2
  Increment the redelivery
  count and re-post
  the message
  end note

  activate queue1
  queue1 - -> service2: ok
  deactivate queue1
  service2 -> redeliveryQueue: Ack
  redeliveryQueue - -> service2: ok
  deactivate service2

  queue1 -> service2: msg(redeliveryCount=2)

  activate service2
  service2 - -> queue1: ok
  service2 -> service2: process(msg)

  service2 -> queue1: Ack
  activate queue1
  queue1 - -> service2: ok
  deactivate queue1
  deactivate service2
else Redelivery count > max redelivery attempts
  activate service1
  service1 -> service1: Log warning
  note over service1: Abandon the message
  deactivate service1
end

deactivate service1
@enduml

PlantUML version 1.2022.5(Sat Apr 30 10:55:52 UTC 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>